@inject NavigationManager NavigationManager
@inject CytoscapeService CytoscapeService

@attribute [Authorize(Policy = Policy.UserOrAdmin)]

@page "/grafico-de-similaridade"
@using MindNose.Front.Models.Response.CytoscapeDTO
<PageTitle>Grafico de Similaridade - MindNose</PageTitle>

<RadzenCard>
    <RadzenStack style="min-height: fit-content;">
        <RadzenRow style="min-height: fit-content;">
            <RadzenColumn Size="12" SizeLG="12" style="min-height: fit-content;">
                <RadzenText TextAlign="TextAlign.Center" TextStyle="TextStyle.H5">Grafico de Similaridade</RadzenText>
                @if(!_elements.Nodes.Any())
                {
                    <RadzenCard Style="margin-top:20px; text-align:center; padding:30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);">
                        <div style="display:flex;
                                    align-items:center;
                                    justify-content:center;
                                    gap:10px;
                                    margin-bottom:10px;">
                            <RadzenIcon Icon="info" Style="font-size:36px; color:#007bff; line-height:1;" />
                            <RadzenText Text="Não há elementos explorados para visualização!" TextStyle="TextStyle.H6" Style="font-weight:500; margin:0; line-height:1.2;" />
                        </div>

                        <RadzenButton Text="Voltar para a página inicial" Icon="home" Click="@(() => NavigationManager.NavigateTo("/"))" Style="padding:12px 24px; border-radius:25px; font-weight:bold;" /> 
                    </RadzenCard>
                }else
                {
                    @foreach (var chartElements in _chartTables)
                    {
                        <SimilarityGraph ChartTable="chartElements" />
                    }
                }
            </RadzenColumn>
        </RadzenRow>
    </RadzenStack>
</RadzenCard>

@code{
    private ElementsDTO _elements = new();
    public List<ChartTable> _chartTables = new();

    protected override void OnAfterRender(bool firstRender)
    {
        if(firstRender)
        {
            _elements = CytoscapeService.GetElements();
            ChartElementInitialize();
            StateHasChanged();
        }
    }

    private void ChartElementInitialize()
    {
        foreach (var node in _elements.Nodes)
        {
            var edges = _elements.Edges
                .Where(e => e.Data.Source == node.Data.Id)
                .DistinctBy(e => e.Data.Id)
                .ToList();

            var newChartElements = new List<ChartElement>();

            foreach (var edge in edges)
            {
                if (edge.Data.Target == null || edge.Data.Extra == null)
                    continue;

                var targetNode = _elements.Nodes.FirstOrDefault(n => n.Data.Id == edge.Data.Target);
                if (targetNode?.Data?.Extra == null)
                    continue;

                if (!edge.Data.Extra.TryGetValue("WeightStartToEnd", out var weightObj) || weightObj == null)
                    continue;

                if (!float.TryParse(weightObj.ToString(), out float value))
                    continue;

                string targetTitle = targetNode.Data.Extra.TryGetValue("Title", out var tVal)
                    ? tVal?.ToString() ?? ""
                    : "";

                float min = 0.0f;
                float max = 0.9f;
                float normalizedValue = ((value - min) / (max - min));
                normalizedValue = Math.Clamp(normalizedValue, 0f, 1.0f);

                newChartElements.Add(new ChartElement
                {
                    Target = targetTitle,
                    WeigthPorcent = normalizedValue
                });
            }

            if (newChartElements.Count == 0)
                continue;

            newChartElements = newChartElements
                .OrderByDescending(c => c.WeigthPorcent)
                .ToList();

            string sourceTitle = node.Data.Extra.TryGetValue("Title", out var sVal)
                ? sVal?.ToString() ?? ""
                : "";

            _chartTables.Add(new ChartTable
            {
                Source = sourceTitle,
                Type = node.Data.Label!,
                ElementsTarget = newChartElements
            });
        }
        _chartTables = _chartTables
        .OrderByDescending(item => item.Type == "Category")
        .DistinctBy(c => c.Source)
        .ToList();
    }
}