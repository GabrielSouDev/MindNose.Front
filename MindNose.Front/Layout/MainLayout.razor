@inject DialogService DialogService
@inject NavigationManager NavigationManager
@inject CytoscapeService CytoscapeService
@inject OpenRouterService OpenRouterService
@inject LocalStorageAuthProvider AuthProvider
@inject ThemeService ThemeService
@inject LocalStorageTheme LocalStorageTheme
@inject IJSRuntime JS

@inherits LayoutComponentBase

<RadzenDialog />
<RadzenComponents />

<HeadContent>
    <RadzenTheme Theme="@_currentTheme" />
</HeadContent>

<RadzenLayout Style="grid-template-columns: 1fr auto; grid-template-areas: 'rz-header rz-header' 'rz-body rz-sidebar'">
    @if (!showOverlay) //tirar negativação e colocara popup
    {

    }else
    {
        <RadzenHeader Style="height: 60px; padding: 10px 25px; margin-bottom: 5px;">
            <AuthorizeView>
                <Authorized>
                    <div style="height: 100%; width: 100%; display: flex; align-items: center; justify-content: space-between;">

                        <!-- Esquerda -->
                        <div style="display:flex; align-items:center; gap:50px;">
                            <RadzenLabel @onclick="@(() => NavigationManager.NavigateTo("/"))"
                                         Style="font-size: 42px; font-weight: 400; cursor:pointer;"
                                         Text="MindNose" />
                            <NavMenu />
                        </div>

                        <!-- Direita -->
                        <div style="display:flex; align-items:center; gap:12px;">
                            <RadzenButton Icon="Light" Variant="Variant.Flat" Click="ToggleThemeAsync"
                                          Style="width:40px; height:40px; border-radius:50%; text-align:center;" />
                            <RadzenButton Text="Sair" Icon="logout" Click="LogOutAsync"
                                          Style="font-weight: bold; padding: 10px 25px; border-radius: 25px; border: none;
                                             box-shadow: 0 4px 15px rgba(0,0,0,0.2);" />
                        </div>

                    </div>
                </Authorized>

                <NotAuthorized>
                    <div style="height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; position: relative;">
                        <RadzenLabel @onclick="@(() => NavigationManager.NavigateTo("/"))"
                                     Style="font-size: 48px; font-weight: 400; cursor:pointer;"
                                     Text="MindNose" />

                        <RadzenButton Icon="Light" Variant="Variant.Flat" Click="ToggleThemeAsync"
                                      Style="position:absolute; right:25px; width:40px; height:40px; border-radius:50%; text-align:center;" />
                    </div>
                </NotAuthorized>
            </AuthorizeView>
        </RadzenHeader>



        <RadzenBody Style="height: 98vh; display: flex; flex-direction: column;" @key="_componentKey">
            @Body
        </RadzenBody>
        <AuthorizeView>
            <Authorized>
                <RadzenButton Icon="Chat"
                              Variant="Variant.Filled"
                              Click="OpenSideDialog"
                              Style="position: fixed; bottom: 50px; right: 50px;
                             width: 60px; height: 60px; border-radius: 50%;
                             box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                             z-index: 1000;" />
            </Authorized>
        </AuthorizeView>
    }
</RadzenLayout>

@code {
    private string _componentKey = Guid.NewGuid().ToString();
    private bool _sidebarExpanded;
    private string _currentTheme = string.Empty;
    private bool showOverlay = true;

    protected override async Task OnInitializedAsync()
    {
        _currentTheme = await LocalStorageTheme.GetTheme();
        if(string.IsNullOrEmpty(_currentTheme))
        {
            _currentTheme = "Standard-Dark";
            await LocalStorageTheme.SetTheme(_currentTheme);
        }

        ThemeService.SetTheme(_currentTheme);
        await JS.InvokeVoidAsync("setTheme", _currentTheme);
        StateHasChanged();
    }

    private void HideOverlay()
    {
        showOverlay = false;
        StateHasChanged();    
    }

    private async Task OpenSideDialog()
    {
        var options = new SideDialogOptions
            {
                CloseDialogOnOverlayClick = true,
                Position = DialogPosition.Right,
                ShowMask = true,
                Style = "border-radius: 15px; height: 100vh; overflow: hidden;",
                Width = "33vw",
                Height = "100%"
            };
        await DialogService.OpenSideAsync<ChatDialog>("Chat", options: options);

        _componentKey = Guid.NewGuid().ToString();
    }

    private async Task ToggleThemeAsync()
    {
        _currentTheme = _currentTheme.ToLower().Contains("dark") ? "Software" : "Standard-Dark";
        ThemeService.SetTheme(_currentTheme);
        await JS.InvokeVoidAsync("setTheme", _currentTheme);
        await LocalStorageTheme.SetTheme(_currentTheme);

        StateHasChanged();
    }
    private async Task LogOutAsync()
    {
        await AuthProvider.MarkUserAsLoggedOutAsync();
        NavigationManager.NavigateTo("/login");
    }
}