@using MindNose.Front.Models.Request.Chat
@inject CytoscapeService CytoscapeService
@inject OpenRouterService OpenRouterService
@inject MindNoseApiService MindNoseService
@inject DialogService DialogService

<!-- Área de Elementos Selecionados -->
<div hidden="@_selectedElementsHidden"
     style="height: 100%; display: flex; flex-direction: column;">

    <div style="display: flex; justify-content: flex-end; padding: 10px;">
        <RadzenButton Icon="Close"
                      Variant="Variant.Filled"
                      Click="ToggleSelectedElements" />
    </div>

    <div style="flex: 1; overflow: hidden;">
        <SelectedElements />
    </div>
</div>

<!-- Chat -->
<RadzenStack Style="height: 100%;" Visible="_selectedElementsHidden">
    <RadzenCard Style="height: 100%; display: flex; flex-direction: column;">

        <!-- Mensagens -->
        <div style="flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column;">
            @foreach (var message in _chatMessage.Messages)
            {
                @if (message.Origin == ChatOrigin.System)
                {
                    <div style="width: 100%; display: flex; justify-content: flex-start;">
                        <div style="width: fit-content; max-width: 90%;
                                    text-align: start; padding: 8px;
                                    border-radius: 10px; margin: 4px;"
                                    class="chat-bubble">
                            <p class="chat" style="margin: 0; white-space: pre-wrap;">
                                @((MarkupString)message.Text!)
                            </p>
                            <p style="margin: 0; font-size: 0.8em;">IA Chat</p>
                        </div>
                    </div>
                }
                else
                {
                    <div style="width: 100%; display: flex; justify-content: flex-end;">
                        <div style="width: fit-content; max-width: 90%;
                                    text-align: end; padding: 8px;
                                    border-radius: 10px; margin: 4px;"
                                    class="chat-bubble">
                            <p class="chat" style="margin: 0; white-space: pre-wrap;">
                                @message.Text
                            </p>
                            <p style="margin: 0; font-size: 0.8em;">@message.Origin</p>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Configurações -->
        <div style="padding: 10px; border-top: 1px solid #ccc;">

            <RadzenStack Orientation="Orientation.Horizontal"
                         AlignItems="AlignItems.Center"
                         Style="width:100%; margin-bottom: 8px; overflow: visible; position: relative;">
                <RadzenLabel Style="width:fit-content; white-space: nowrap;" Text="Modelo:" />
                <RadzenDropDown @bind-Value="_selectedModelId"
                                Data="_modelsChat"
                                TextProperty="@nameof(ChatModel.Name)"
                                ValueProperty="@nameof(ChatModel.Id)"
                                Style="width: 100%;"
                                PopupStyle="top: auto; bottom: 100%; max-height: 250px; overflow-y: auto;" />
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal"
                         AlignItems="AlignItems.Center"
                         Style="width:100%; margin-bottom: 8px; overflow: visible; position: relative;">
                <RadzenLabel Style="width:fit-content; white-space: nowrap;" Text="Tipo de saída:" />
                <RadzenDropDown @bind-Value="_outputModeSelected"
                                Data="_outputModeList"
                                Placeholder="Modo de saída"
                                TextProperty="Text"
                                ValueProperty="Value"
                                Style="width: 100%;"
                                PopupStyle="top: auto; bottom: 100%; max-height: 250px; overflow-y: auto;" />
            </RadzenStack>


            <!-- Botão Elementos -->
            <div style="display: flex; justify-content: flex-end; padding: 6px 0;">
                <RadzenButton Text="Elementos Selecionados"
                              Click="ToggleSelectedElements" />
            </div>

            <!-- Entrada de mensagem -->
            <RadzenTextArea Placeholder="Escreva sua mensagem."
                            Value="@_textBox.Text"
                            @oninput="e => _textBox.Text = e.Value?.ToString()"
                            @onkeydown="HandleKeyDownAsync"
                            Style="width: 100%; resize: none;" />

            <div style="display: flex; justify-content: flex-end; padding: 10px 0;">
                <RadzenButton Text="Enviar"
                              Click="SubmitAsync"
                              Style="margin-top: 10px; margin-bottom: 10px;" />
            </div>
        </div>
    </RadzenCard>
</RadzenStack>


@code{
	private bool _selectedElementsHidden = true;
	private List<ChatModel> _modelsChat = new();
	private ConversationGuide _chatMessage = new();
	private string _selectedModelId = string.Empty;
	private Message _textBox = new()
	{
		Text = string.Empty,
		Origin = ChatOrigin.User
	};

    private OutputMode _outputModeSelected = OutputMode.Conversational;

    private List<OutputModeItem> _outputModeList = new()
    {
        new OutputModeItem { Text = "Informal", Value = OutputMode.Informal },
        new OutputModeItem { Text = "Formal", Value = OutputMode.Formal },
        new OutputModeItem { Text = "Artigo", Value = OutputMode.Article },
        new OutputModeItem { Text = "Resposta Rápida", Value = OutputMode.Summary },
        new OutputModeItem { Text = "Conversa", Value = OutputMode.Conversational },
        new OutputModeItem { Text = "Técnico", Value = OutputMode.Technical },
        new OutputModeItem { Text = "Criativo", Value = OutputMode.Creative },
        new OutputModeItem { Text = "Código", Value = OutputMode.Code }
    };


	protected override void OnParametersSet()
	{
		var models = OpenRouterService.GetChatModels();
		if (models?.Data != null && models.Data.Any())
		{
			_modelsChat = models.Data.Select(m => new ChatModel(m.Id, m.Name)).OrderBy(m => m.Name).ToList();

			var model = _modelsChat.FirstOrDefault(m => m.Id == "mistralai/mistral-small-3.2-24b-instruct");
			if (model is not null)
			{
				_selectedModelId = model.Id;
			}
			else
				_selectedModelId = _modelsChat.First().Id;

		}
	}

	protected override void OnInitialized()
	{
		_chatMessage.Messages.Add(new Message { Text = "Bem-vindo ao MindNose!" });
		_chatMessage.Messages.Add(new Message { Text = "Digite sua dúvida." });

		StateHasChanged();
	}

	private async Task SubmitAsync()
	{
		if(!string.IsNullOrEmpty(_textBox.Text))
			_chatMessage.Messages.Add(new Message { Text = _textBox.Text, Origin = ChatOrigin.User });

		var selectedElementsHeader = CytoscapeService.GetSelectedElementsHeader();

		var request = new ChatRequest
			{
				ElementsHeader = selectedElementsHeader,
				Message = _textBox,
                OutputMode = _outputModeSelected,
				Model = _selectedModelId
			};

		_textBox.Text = string.Empty;

		_chatMessage.Messages.Add(new Message { Text = "Pensando..", Origin = ChatOrigin.System });

		var response = await MindNoseService.SendChatAsync(request);

		_chatMessage.Messages.RemoveAt(_chatMessage.Messages.Count - 1);

		if (!string.IsNullOrEmpty(response))
			_chatMessage.Messages.Add(new Message { Text = Markdown.ToHtml(response), Origin = ChatOrigin.System });
	}

	private async Task HandleKeyDownAsync(KeyboardEventArgs args)
	{
		if (args.Key == "Enter" && !args.ShiftKey)
		{
			await SubmitAsync();
		}
	}

	private void ToggleSelectedElements()
	{

		_selectedElementsHidden = !_selectedElementsHidden;
		StateHasChanged();
	}
}